<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>index</title>
    <script type="text/javascript" src="synthesizer.js"></script>
  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      var app = Elm.Synthesizer.fullscreen()

      var context = new AudioContext();
      initAudioElements(context);

      app.ports.play.subscribe(function (frequency) {
        osc = context.createOscillator();
        osc.frequency.value = frequency;

        osc.connect(vol);
        osc.start();
        currentPlayedOscillators[frequency] = osc;
      });

      app.ports.stop.subscribe(function (frequency) {
        osc = currentPlayedOscillators[frequency]
          // Seems that Web Audio Api sometimes creates the oscillator
          // but it can't be found inside Javascript (probably because of)
          // performance issues, this forces to load audio context
          // elements
          if (osc == null) {
            vol.disconnect();
            initAudioElements(context);
          } else {
            osc.disconnect();
            delete currentPlayedOscillators[frequency];
          }
      });

      function initAudioElements(audioContext) {
        window.vol = context.createGain();
        window.currentPlayedOscillators = {};

        vol.gain.value = 1;
        vol.connect(context.destination);
      };
    </script>
  </body>
</html>
